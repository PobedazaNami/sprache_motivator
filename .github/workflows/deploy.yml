name: Deploy to Server

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate required secrets
        run: |
          MISSING=()
          test -n "${{ secrets.TELEGRAM_BOT_TOKEN }}" || MISSING+=(TELEGRAM_BOT_TOKEN)
          test -n "${{ secrets.OPENAI_API_KEY }}" || MISSING+=(OPENAI_API_KEY)
          test -n "${{ secrets.SSH_PRIVATE_KEY }}" || MISSING+=(SSH_PRIVATE_KEY)
          test -n "${{ secrets.SSH_HOST }}" || MISSING+=(SSH_HOST)
          test -n "${{ secrets.SSH_USER }}" || MISSING+=(SSH_USER)
          if [ ${#MISSING[@]} -gt 0 ]; then
            echo "Missing required secrets: ${MISSING[*]}"; exit 1; fi
          echo "All required secrets present"
          # MongoDB is optional; if configured it will be passed through during deploy

      - name: Prepare SSH and env
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -p 22 -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

          MONGODB_URI="${{ secrets.MongoDB }}"
          MONGODB_URI="${MONGODB_URI:-mongodb://localhost:27017/sprache_motivator}"
          WEBAPP_URL="${{ secrets.WEBAPP_URL }}"
          WEBAPP_PORT="${{ secrets.WEBAPP_PORT }}"
          WEBAPP_HOST=$(echo "${WEBAPP_URL}" | sed 's~https\?://~~' | sed 's~/.*~~')

          : > .env.tmp
          echo "BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}" >> .env.tmp
          echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> .env.tmp
          echo "ADMIN_IDS=662790795" >> .env.tmp
          echo "MONGODB_URI=${MONGODB_URI}" >> .env.tmp
          echo "REDIS_HOST=redis" >> .env.tmp
          echo "REDIS_PORT=6379" >> .env.tmp
          echo "MAX_CONCURRENT_USERS=100" >> .env.tmp
          echo "DAILY_TRAINER_TIMES=08:00,14:00,20:00" >> .env.tmp
          echo "MAX_TOKENS_PER_USER_DAILY=10000" >> .env.tmp
          echo "CACHE_TTL_SECONDS=2592000" >> .env.tmp
          test -n "${WEBAPP_URL:-}" && echo "WEBAPP_URL=${WEBAPP_URL}" >> .env.tmp || true
          test -n "${WEBAPP_PORT:-}" && echo "WEBAPP_PORT=${WEBAPP_PORT}" >> .env.tmp || true
          test -n "${WEBAPP_HOST:-}" && echo "WEBAPP_HOST=${WEBAPP_HOST}" >> .env.tmp || true
          echo "==> .env.tmp created"

      - name: Test SSH connection
        run: |
          ssh -i ~/.ssh/deploy_key -p 22 -o ConnectTimeout=10 ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "echo 'SSH OK'; uname -a"

      - name: Create deploy dir
        run: |
          ssh -i ~/.ssh/deploy_key -p 22 ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "mkdir -p /opt/sprache_motivator"

      - name: Rsync files to server
        run: |
          rsync -avz --delete --checksum \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='.env*' \
            --exclude='*.pyc' \
            --exclude='__pycache__' \
            --exclude='.pytest_cache' \
            --exclude='logs/*' \
            --exclude='.gitignore' \
            -e "ssh -i ~/.ssh/deploy_key -p 22" \
            ./ ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/opt/sprache_motivator/

      - name: Upload .env
        run: |
          scp -i ~/.ssh/deploy_key -P 22 .env.tmp ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/opt/sprache_motivator/.env

      - name: Docker build and deploy
        run: |
          ssh -i ~/.ssh/deploy_key -p 22 ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} bash -s <<'REMOTE'
          set -euo pipefail
          cd /opt/sprache_motivator
          echo "==> Stopping containers..."
          /usr/bin/docker compose down || true
          echo "==> Pruning images..."
          /usr/bin/docker image prune -f
          echo "==> Building bot image..."
          /usr/bin/docker compose build --no-cache --pull bot
          echo "==> Starting containers..."
          /usr/bin/docker compose up -d
          echo "==> docker compose ps:"
          /usr/bin/docker compose ps
          echo "==> bot logs (last 300 lines):"
          /usr/bin/docker compose logs --tail=300 bot || true
          REMOTE

      - name: Cleanup
        if: always()
        run: rm -f ~/.ssh/deploy_key .env.tmp
