name: Deploy to Server

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate required secrets
        run: |
          MISSING=()
          test -n "${{ secrets.TELEGRAM_BOT_TOKEN }}" || MISSING+=(TELEGRAM_BOT_TOKEN)
          test -n "${{ secrets.OPENAI_API_KEY }}" || MISSING+=(OPENAI_API_KEY)
          test -n "${{ secrets.SSH_PRIVATE_KEY }}" || MISSING+=(SSH_PRIVATE_KEY)
          test -n "${{ secrets.SSH_HOST }}" || MISSING+=(SSH_HOST)
          test -n "${{ secrets.SSH_USER }}" || MISSING+=(SSH_USER)
          if [ ${#MISSING[@]} -gt 0 ]; then
            echo "Missing required secrets: ${MISSING[*]}"; exit 1; fi
          echo "All required secrets present"
          # MongoDB is optional; if configured it will be passed through during deploy

      - name: Deploy to server
        run: |
          set -euo pipefail
          # Assign variables from GitHub contexts
          TELEGRAM_BOT_TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}"
          OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}"
          # Admin ID for @reeziat
          ADMIN_IDS='662790795'
          # MongoDB URI (use secret if provided, otherwise use default)
          MONGODB_URI="${{ secrets.MongoDB }}"
          MONGODB_URI="${MONGODB_URI:-mongodb://localhost:27017/sprache_motivator}"
          REDIS_HOST='redis'
          REDIS_PORT='6379'
          MAX_CONCURRENT_USERS='100'
          DAILY_TRAINER_TIMES='08:00,14:00,20:00'
          MAX_TOKENS_PER_USER_DAILY='10000'
          CACHE_TTL_SECONDS='2592000'
          # Web App (Mini App) configuration
          WEBAPP_URL="${{ secrets.WEBAPP_URL }}"
          WEBAPP_PORT="${{ secrets.WEBAPP_PORT }}"
          # Extract hostname from WEBAPP_URL for nginx-proxy (remove https:// and any path)
          WEBAPP_HOST=$(echo "${WEBAPP_URL}" | sed 's~https\?://~~' | sed 's~/.*~~')
          SSH_PRIVATE_KEY="${{ secrets.SSH_PRIVATE_KEY }}"
          SSH_HOST='${{ secrets.SSH_HOST }}'
          SSH_USER='${{ secrets.SSH_USER }}'
          SSH_PORT='22'
          DEPLOY_PATH='/opt/sprache_motivator'

          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -p ${SSH_PORT:-22} -H ${SSH_HOST} >> ~/.ssh/known_hosts

          if [ -f requirements.txt ]; then
            echo "Local requirements.txt sha256:"; (sha256sum requirements.txt || shasum -a 256 requirements.txt) || true
          fi

          : > .env.tmp
          echo "BOT_TOKEN=${TELEGRAM_BOT_TOKEN}" >> .env.tmp
          echo "OPENAI_API_KEY=${OPENAI_API_KEY}" >> .env.tmp
          echo "ADMIN_IDS=${ADMIN_IDS}" >> .env.tmp
          echo "MONGODB_URI=${MONGODB_URI}" >> .env.tmp
          echo "REDIS_HOST=${REDIS_HOST:-redis}" >> .env.tmp
          echo "REDIS_PORT=${REDIS_PORT:-6379}" >> .env.tmp
          echo "MAX_CONCURRENT_USERS=${MAX_CONCURRENT_USERS:-100}" >> .env.tmp
          echo "DAILY_TRAINER_TIMES=${DAILY_TRAINER_TIMES:-08:00,14:00,20:00}" >> .env.tmp
          echo "MAX_TOKENS_PER_USER_DAILY=${MAX_TOKENS_PER_USER_DAILY:-10000}" >> .env.tmp
          echo "CACHE_TTL_SECONDS=${CACHE_TTL_SECONDS:-2592000}" >> .env.tmp
          # Add Web App variables if configured
          test -n "${WEBAPP_URL:-}" && echo "WEBAPP_URL=${WEBAPP_URL}" >> .env.tmp || true
          test -n "${WEBAPP_HOST:-}" && echo "WEBAPP_HOST=${WEBAPP_HOST}" >> .env.tmp || true
          test -n "${WEBAPP_PORT:-}" && echo "WEBAPP_PORT=${WEBAPP_PORT}" >> .env.tmp || true

          ssh -i ~/.ssh/deploy_key -p ${SSH_PORT:-22} ${SSH_USER}@${SSH_HOST} "mkdir -p ${DEPLOY_PATH}"

          rsync -avz --delete --checksum \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='.env*' \
            --exclude='*.pyc' \
            --exclude='__pycache__' \
            --exclude='.pytest_cache' \
            --exclude='logs/*' \
            --exclude='.gitignore' \
            -e "ssh -i ~/.ssh/deploy_key -p ${SSH_PORT:-22}" \
            ./ ${SSH_USER}@${SSH_HOST}:${DEPLOY_PATH}/

          scp -i ~/.ssh/deploy_key -P ${SSH_PORT:-22} .env.tmp ${SSH_USER}@${SSH_HOST}:${DEPLOY_PATH}/.env

          ssh -i ~/.ssh/deploy_key -p ${SSH_PORT:-22} ${SSH_USER}@${SSH_HOST} "grep -i '^openai' ${DEPLOY_PATH}/requirements.txt || echo 'openai entry not found'; (sha256sum ${DEPLOY_PATH}/requirements.txt || shasum -a 256 ${DEPLOY_PATH}/requirements.txt || true) 2>/dev/null"

          # Run docker compose commands on remote host. Avoid nested bash -c to prevent parsing issues with parentheses/newlines.
          # Added: docker compose pull + docker image prune to ensure fresh images are used
          ssh -i ~/.ssh/deploy_key -p ${SSH_PORT:-22} ${SSH_USER}@${SSH_HOST} 'set -euo pipefail && cd '"${DEPLOY_PATH}"' && /usr/bin/docker compose down || true && /usr/bin/docker image prune -f && /usr/bin/docker compose build --no-cache --pull bot && /usr/bin/docker compose up -d && echo "--- docker compose ps ---" && /usr/bin/docker compose ps && echo "--- bot logs (last 300 lines) ---" && /usr/bin/docker compose logs --tail=300 bot || true'

          rm -f ~/.ssh/deploy_key .env.tmp
