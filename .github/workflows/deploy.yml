name: Deploy to Server

on:
  push:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create .env from GitHub Secrets/Vars
        id: write-env
        run: |
          set -e
          mkdir -p artifact
          {
            echo "# Generated by GitHub Actions at $(date -u)";
            echo "BOT_TOKEN=${{ secrets.BOT_TOKEN }}";
            echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}";
            echo "POSTGRES_DB=${{ vars.POSTGRES_DB || 'sprache_bot' }}";
            echo "POSTGRES_USER=${{ vars.POSTGRES_USER || 'sprache_user' }}";
            echo "POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}";
            echo "POSTGRES_HOST=${{ vars.POSTGRES_HOST || 'postgres' }}";
            echo "POSTGRES_PORT=${{ vars.POSTGRES_PORT || '5432' }}";
            echo "REDIS_HOST=${{ vars.REDIS_HOST || 'redis' }}";
            echo "REDIS_PORT=${{ vars.REDIS_PORT || '6379' }}";
            echo "ADMIN_IDS=${{ vars.ADMIN_IDS || '' }}";
            echo "MAX_CONCURRENT_USERS=${{ vars.MAX_CONCURRENT_USERS || '100' }}";
            echo "DAILY_TRAINER_TIMES=${{ vars.DAILY_TRAINER_TIMES || '08:00,14:00,20:00' }}";
            echo "MAX_TOKENS_PER_USER_DAILY=${{ vars.MAX_TOKENS_PER_USER_DAILY || '10000' }}";
            echo "CACHE_TTL_SECONDS=${{ vars.CACHE_TTL_SECONDS || '2592000' }}";
          } > artifact/.env
          echo "WROTE_ENV=1" >> $GITHUB_OUTPUT

      - name: Copy repo to server via rsync
        uses: burnett01/rsync-deployments@5.2
        with:
          switches: -az --delete --exclude ".git" --exclude ".github"
          path: ./
          remote_path: /opt/sprache_motivator
          remote_host: ${{ secrets.SERVER_HOST }}
          remote_user: ${{ secrets.SERVER_USER }}
          remote_key: ${{ secrets.SERVER_SSH_KEY }}

      - name: Ship .env to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: "artifact/.env"
          target: "/opt/sprache_motivator"
          strip_components: 1

      - name: Compose up
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            set -e
            cd /opt/sprache_motivator
            docker compose down || true
            docker compose up -d --build
