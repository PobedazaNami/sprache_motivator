# Support Messaging Flow Diagram

## Complete Flow Visualization

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         SUPPORT MESSAGING FLOW                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

USER SIDE                           BOT                         ADMIN SIDE
â•â•â•â•â•â•â•â•â•â•â•                        â•â•â•â•â•                        â•â•â•â•â•â•â•â•â•â•â•

   â”‚                                 â”‚                               â”‚
   â”‚  1. Click "ğŸ’¬ Ğ¢ĞµÑ…Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ°"     â”‚                               â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                               â”‚
   â”‚                                 â”‚                               â”‚
   â”‚  2. Prompt: "ĞĞ°Ğ¿Ğ¸ÑˆĞ¸Ñ‚Ğµ ÑĞ²Ğ¾Ğµ      â”‚                               â”‚
   â”‚     ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ..."               â”‚                               â”‚
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                               â”‚
   â”‚     [Cancel button shown]       â”‚                               â”‚
   â”‚                                 â”‚                               â”‚
   â”‚  3. User types message:         â”‚                               â”‚
   â”‚     "Ğ£ Ğ¼ĞµĞ½Ñ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ° Ñ Ğ±Ğ¾Ñ‚Ğ¾Ğ¼"   â”‚                               â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                               â”‚
   â”‚                                 â”‚                               â”‚
   â”‚  4. Confirmation:               â”‚  5. Forward to admins:        â”‚
   â”‚     "âœ… Ğ’Ğ°ÑˆĞµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ          â”‚     "ğŸ“© Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¾Ñ‚          â”‚
   â”‚      Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾!"               â”‚      Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ:            â”‚
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      ğŸ‘¤ Ivan Petrov           â”‚
   â”‚     [Main menu shown]           â”‚      @ivanpetrov              â”‚
   â”‚                                 â”‚      ID: 12345                â”‚
   â”‚                                 â”‚                               â”‚
   â”‚                                 â”‚      ğŸ’¬ Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ:            â”‚
   â”‚                                 â”‚      Ğ£ Ğ¼ĞµĞ½Ñ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ° Ñ Ğ±Ğ¾Ñ‚Ğ¾Ğ¼" â”‚
   â”‚                                 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                                 â”‚                               â”‚
   â”‚                                 â”‚  6. [Message copied]          â”‚
   â”‚                                 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                                 â”‚                               â”‚
   â”‚                                 â”‚  7. Admin uses Telegram's     â”‚
   â”‚                                 â”‚     native "Reply" feature    â”‚
   â”‚                                 â”‚     "ĞœÑ‹ Ñ€Ğ°Ğ·Ğ±ĞµÑ€ĞµĞ¼ÑÑ Ñ ÑÑ‚Ğ¸Ğ¼"    â”‚
   â”‚                                 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                                 â”‚                               â”‚
   â”‚  8. Admin's reply delivered:    â”‚  9. Confirmation to admin:    â”‚
   â”‚     "ğŸ“¬ ĞÑ‚Ğ²ĞµÑ‚ Ğ¾Ñ‚ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ°:â”‚     "âœ… ĞÑ‚Ğ²ĞµÑ‚ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½       â”‚
   â”‚      ĞœÑ‹ Ñ€Ğ°Ğ·Ğ±ĞµÑ€ĞµĞ¼ÑÑ Ñ ÑÑ‚Ğ¸Ğ¼"      â”‚      Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ"            â”‚
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                                 â”‚                               â”‚
   â”‚                                 â”‚                               â”‚
   â–¼                                 â–¼                               â–¼


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

EDGE CASES:

1. User Cancels:
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   User clicks "âŒ ĞÑ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ" (Cancel)
   â†’ State cleared
   â†’ Main menu shown
   â†’ No message sent to admins

2. Multiple Admins:
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Message forwarded to ALL configured admins
   Any admin can reply
   Reply goes to original user

3. Non-Admin Reply:
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Regular user tries to reply
   â†’ Handler returns early
   â†’ No action taken
   â†’ System ignores the message

4. Error Handling:
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Admin notification fails â†’ Error logged, user still gets confirmation
   User notification fails â†’ Error logged, admin gets error message
   Invalid user ID â†’ Error logged, admin informed


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

STATE MACHINE:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Initial    â”‚
â”‚    State     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”‚ User clicks Support button
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SupportStates.      â”‚
â”‚  waiting_for_message â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”œâ”€â”€â”€ User types message â”€â”€â”€â”€â”€> Message sent, state cleared
        â”‚
        â””â”€â”€â”€ User cancels â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> State cleared, back to menu


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

MESSAGE IDENTIFICATION:

Admin reply detection relies on:
1. Sender must be in ADMIN_IDS
2. Message must be a reply (reply_to_message exists)
3. Replied message must contain "ID: {user_id}" pattern
4. User ID extracted and validated

Security:
âœ“ Only admins can trigger reply handler
âœ“ User ID extracted from context, not user input
âœ“ All errors logged but not exposed
âœ“ No direct message forwarding (prevents spoofing)
```

## Key Components

### Files Modified

1. **bot/handlers/settings.py** (112 lines added):
   - `SupportStates` class
   - `support_message()` - Initiates conversation
   - `receive_support_message()` - Processes user message
   - `handle_admin_reply()` - Processes admin reply

2. **bot/locales/texts.py** (8 lines added):
   - Ukrainian and Russian translations for:
     - `support_prompt`
     - `support_message_sent`
     - `support_admin_reply`
     - `btn_cancel`

3. **bot/utils/keyboards.py** (8 lines added):
   - `get_cancel_keyboard()` function

### Files Created

1. **test_support_messaging.py** (183 lines):
   - Unit tests for all handlers
   - Localization tests

2. **test_support_integration.py** (234 lines):
   - Complete flow integration test
   - Edge case tests
   - Multiple admins test

3. **SUPPORT_MESSAGING.md** (109 lines):
   - Feature documentation
   - User guide
   - Admin guide
   - Technical details

4. **SUPPORT_FLOW_DIAGRAM.md** (this file):
   - Visual flow diagram
   - Edge cases explanation
   - State machine diagram

## Benefits

âœ… **User Experience**: Direct communication without leaving the bot
âœ… **Admin Experience**: All requests in one place, familiar interface
âœ… **Security**: Proper permission checks, ID extraction from context
âœ… **Reliability**: Error handling, logging, confirmations
âœ… **Maintainability**: Follows existing patterns, well-tested
âœ… **Localization**: Full support for Ukrainian and Russian
